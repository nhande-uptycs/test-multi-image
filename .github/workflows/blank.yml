name: Build and Scan Multiple Images (Matrix)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  discover-dockerfiles:
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.set-matrix.outputs.dockerfiles }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Discover Dockerfiles
        id: set-matrix
        run: |
          # Find all Dockerfiles
          files=$(ls Dockerfile Dockerfile[0-9]* 2>/dev/null || echo "Dockerfile")
          
          # Convert to JSON array
          json_array=$(echo "$files" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "dockerfiles=$json_array" >> $GITHUB_OUTPUT
          echo "Found Dockerfiles: $json_array"
          
  build-and-scan:
    needs: discover-dockerfiles
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile: ${{ fromJson(needs.discover-dockerfiles.outputs.dockerfiles) }}
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set image name
        id: image-name
        run: |
          if [ "${{ matrix.dockerfile }}" = "Dockerfile" ]; then
            echo "name=my-app" >> $GITHUB_OUTPUT
          else
            number=$(echo "${{ matrix.dockerfile }}" | sed 's/Dockerfile//')
            echo "name=my-app${number}" >> $GITHUB_OUTPUT
          fi

      
      - name: Build Docker image
        run: |
          docker build -f ${{ matrix.dockerfile }} \
                       -t ${{ steps.image-name.outputs.name }}:latest .
                       
      - name: Scan with Uptycs
        uses: uptycslabs/uptycs-action@main
        with:
          credentials: ${{ secrets.UPTYCS_CREDENTIALS }}
          image: ${{ steps.image-name.outputs.name }}:latest
          output-format: "json"
          output-name: ${{ steps.image-name.outputs.name }}-scan
          verbose: true
          exit-on-error: false
      

      # - name: Upload scan results
      #   if: always()
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: ${{ matrix.image-name }}-scan-results
      #     path: |
      #       *-scan-*.json
      #       *-scan-*.csv
